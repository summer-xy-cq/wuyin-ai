# 体质判断逻辑修复记录

## 问题描述

**时间**: 2025-02-12
**现象**: 用户反馈阳虚60分、特禀质83分，却被判断为阳虚质
**根本原因**: 数据缓存/脏数据导致的计算异常

## 调试过程

### 1. 初步分析

控制台输出显示：
```javascript
scores.transformed: {}  // 空的！
primary: {key: 'yangxu', score: 60}
tendencies: []
```

发现 `transformed` 分数对象是空的，说明计算逻辑未正确执行。

### 2. 添加调试日志

修改文件 `src/utils/scoring.js`：
- 在 `calculateScores()` 中添加详细的输入/输出日志
- 在 `determineConstitution()` 中记录判定过程
- 在 `getPrimaryConstitution()` 中记录选择逻辑

修改文件 `src/views/Result.vue`：
- 在 `loadData()` 中检查答案数据完整性
- 验证特禀质题目（25-27题）是否存在
- 添加 `getFullAssessment` 原始返回日志

### 3. 发现的问题

1. **缓存数据混用**: `CONSTITUTION` 和 `ANSWERS` 存储键可能存储了不同步的数据
2. **手动输入路径**: Diagnosis.vue 手动选择体质时 `isManual: true`，不会计算分数
3. **数据格式问题**: 答案数据可能缺少部分题目（如特禀质的25-27题）

### 4. 修复措施

#### Result.vue 添加数据完整性检查
```javascript
// 检查答案数据是否完整，特禀质题目（25-27）必须存在
const missingQuestions = QUESTIONS_FREE.filter(q => answers[q.id] === undefined)
if (missingQuestions.length > 0) {
    console.error('[Result] 答案数据不完整，缺少题目:', missingQuestions)
    // 清理脏数据，让用户重新答题
    storage.remove('ANSWERS')
    storage.remove('CONSTITUTION')
    router.push('/assessment')
    return
}
```

#### scoring.js 增强调试能力
```javascript
export function calculateScores(answers, questions) {
    console.log('[calculateScores] CONSTITUTIONS keys:', Object.keys(CONSTITUTIONS))
    console.log('[calculateScores] answers:', answers)
    // ... 详细日志
}
```

## 验证结果

重新答题后体质判断逻辑正常工作：
- 特禀质高分（83分）正确识别
- 雷达图数据完整显示
- 倾向体质列表正确生成

## 后续建议

1. **数据清理**: 用户首次加载时检查并清理旧版本数据
2. **版本标记**: 给 ANSWERS 数据添加版本号，避免格式不兼容
3. **错误边界**: 增加更多错误处理和用户提示

## 相关文件

- `src/utils/scoring.js` - 评分算法核心
- `src/views/Result.vue` - 结果展示页面
- `src/data/questions-free.js` - 27题问卷数据
- `src/utils/storage.js` - 本地存储封装
